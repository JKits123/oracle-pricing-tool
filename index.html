// FIX 1: Outdoor unit switching when changing indoor manufacturer
function updateIndoorManufacturer() {
    const manufacturer = document.getElementById('indoorManufacturer').value;
    state.indoorManufacturer = manufacturer;
    
    // Auto-update outdoor manufacturer to match (FIXES ISSUE #1)
    state.outdoorManufacturer = manufacturer;
    document.getElementById('outdoorManufacturer').value = manufacturer;
    
    displayIndoorUnits();
    displayOutdoorUnits(); // Update outdoor units when indoor changes
}

// FIX 2: Materials filtering to remove unnecessary items
function updateMaterials() {
    const container = document.getElementById('materialsList');
    container.innerHTML = '';
    
    state.materials = [];
    
    // Filter out unnecessary materials (FIXES ISSUE #2)
    Object.values(materialsDatabase).forEach(category => {
        category.forEach(material => {
            if (!material.exclude) { // Filter out flare nuts and other unnecessary items
                if (material.required || shouldIncludeMaterial(material)) {
                    state.materials.push(material);
                    
                    const item = document.createElement('div');
                    item.className = 'material-item';
                    item.innerHTML = `
                        <span>${material.name}</span>
                        <span>£${material.price.toFixed(2)}</span>
                    `;
                    container.appendChild(item);
                }
            }
        });
    });
    
    updateCableTrayWidth(); // Auto-select cable tray width
    calculateTotals();
}

// FIX 3: Intelligent cable tray width selection
function updateCableTrayWidth() {
    const cableCount = calculateCableRequirements();
    let recommendedWidth = 100;
    
    if (cableCount > 10) recommendedWidth = 300;
    else if (cableCount > 6) recommendedWidth = 200;
    else if (cableCount > 3) recommendedWidth = 150;
    
    document.getElementById('cableTrayWidth').value = recommendedWidth;
}

function calculateCableRequirements() {
    // Calculate based on system capacity and type
    const baseCount = state.capacity ? Math.ceil(state.capacity / 2) : 2;
    const systemMultiplier = state.systemType === 'multi-split' ? 1.5 : 1;
    return Math.ceil(baseCount * systemMultiplier);
}

// FIX 4: Simplified labour structure
function updateLabour() {
    const labourType = document.getElementById('labourType').value;
    const container = document.getElementById('labourBreakdown');
    container.innerHTML = '';
    
    state.labour = labourRates[labourType] || {};
    
    Object.values(state.labour).forEach(item => {
        const div = document.createElement('div');
        div.className = 'material-item';
        const cost = item.rate * item.hours;
        div.innerHTML = `
            <span>${item.description} (${item.hours}h @ £${item.rate}/h)</span>
            <span>£${cost.toFixed(2)}</span>
        `;
        container.appendChild(div);
    });
    
    calculateTotals();
}

// FIX 5: Hire equipment with delivery costs
function updateHireBreakdown() {
    const container = document.getElementById('hireBreakdown');
    container.innerHTML = '';
    
    const distance = parseFloat(document.getElementById('deliveryDistance').value) || 0;
    const deliveryMultiplier = distance > 50 ? 1.5 : 1;
    
    state.hireEquipment.forEach(item => {
        const deliveryCost = item.delivery * deliveryMultiplier;
        const totalCost = item.daily + deliveryCost;
        
        const div = document.createElement('div');
        div.className = 'material-item';
        div.innerHTML = `
            <div>
                <strong>${item.name}</strong><br>
                <small>Daily: £${item.daily} + Delivery: £${deliveryCost.toFixed(2)}</small>
            </div>
            <span>£${totalCost.toFixed(2)}</span>
        `;
        container.appendChild(div);
    });
    
    calculateTotals();
}

// FIX 6: Summary totals calculation
function calculateTotals() {
    // Equipment total
    state.totals.equipment = 0;
    if (state.selectedIndoorUnit) state.totals.equipment += state.selectedIndoorUnit.price;
    if (state.selectedOutdoorUnit) state.totals.equipment += state.selectedOutdoorUnit.price;
    
    // Materials total
    state.totals.materials = state.materials.reduce((sum, material) => sum + material.price, 0);
    
    // Cable tray cost
    const cableTrayWidth = parseInt(document.getElementById('cableTrayWidth').value) || 100;
    const cableTrayCost = (cableTrayWidth / 100) * 25; // £25 per 100mm width
    state.totals.materials += cableTrayCost;
    
    // Labour total
    state.totals.labour = Object.values(state.labour)
        .reduce((sum, item) => sum + (item.rate * item.hours), 0);
    
    // Hire equipment total
    const distance = parseFloat(document.getElementById('deliveryDistance').value) || 0;
    const deliveryMultiplier = distance > 50 ? 1.5 : 1;
    state.totals.hire = state.hireEquipment
        .reduce((sum, item) => sum + item.daily + (item.delivery * deliveryMultiplier), 0);
    
    // Grand total
    state.totals.grand = state.totals.equipment + state.totals.materials + 
                       state.totals.labour + state.totals.hire;
}

// Update summary display
function updateSummaryTotals() {
    calculateTotals();
    
    document.getElementById('equipmentTotal').textContent = `£${state.totals.equipment.toFixed(2)}`;
    document.getElementById('materialsTotal').textContent = `£${state.totals.materials.toFixed(2)}`;
    document.getElementById('labourTotal').textContent = `£${state.totals.labour.toFixed(2)}`;
    document.getElementById('hireTotal').textContent = `£${state.totals.hire.toFixed(2)}`;
    document.getElementById('grandTotal').textContent = `£${state.totals.grand.toFixed(2)}`;
}

// Update your materials database to exclude unnecessary items
const materialsDatabase = {
    piping: [
        { id: 'pipe-6mm', name: '6mm Copper Pipe (per meter)', price: 8.50, required: true },
        { id: 'pipe-10mm', name: '10mm Copper Pipe (per meter)', price: 12.50, required: true }
    ],
    electrical: [
        { id: 'cable-3core', name: '3 Core Cable (per meter)', price: 4.20, required: true },
        { id: 'isolator', name: 'Electrical Isolator', price: 45.00, required: true }
    ],
    fittings: [
        { id: 'bracket-wall', name: 'Wall Mounting Bracket', price: 35.00, required: true },
        { id: 'drain-pump', name: 'Condensate Drain Pump', price: 120.00, required: false }
    ],
    unnecessary: [
        { id: 'flare-nuts', name: 'Flare Nuts', price: 5.00, required: false, exclude: true }
        // Add other unnecessary items here with exclude: true
    ]
};
